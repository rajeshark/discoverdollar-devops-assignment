name: CI-CD

on:
  push:
    branches: [ main ]

jobs:
  detect:
    runs-on: ubuntu-latest
    outputs:
      frontend: ${{ steps.filter.outputs.frontend }}
      backend:  ${{ steps.filter.outputs.backend }}
      compose:  ${{ steps.filter.outputs.compose }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - id: filter
        uses: dorny/paths-filter@v2
        with:
          filters: |
            frontend:
              - 'frontend/**'
            backend:
              - 'backend/**'
            compose:
              - 'docker-compose.yml'

  build-backend:
    needs: detect
    if: ${{ needs.detect.outputs.backend == 'true' || needs.detect.outputs.compose == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - uses: docker/build-push-action@v5
        with:
          context: ./backend
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/backend:latest

  build-frontend:
    needs: detect
    if: ${{ needs.detect.outputs.frontend == 'true' || needs.detect.outputs.compose == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - uses: docker/build-push-action@v5
        with:
          context: ./frontend
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/frontend:latest

  deploy:
    needs: [detect, build-backend, build-frontend]
    if: ${{ needs.detect.outputs.backend == 'true' || needs.detect.outputs.frontend == 'true' || needs.detect.outputs.compose == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: Install SSH key
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.VM_SSH_KEY }}
          known_hosts: unnecessary

      - name: Deploy via SSH
        run: |
          ssh -o StrictHostKeyChecking=no \
              -p ${{ secrets.VM_SSH_PORT }} \
              ${{ secrets.VM_USER }}@${{ secrets.VM_HOST }} << 'EOF'
            set -e
            cd ~/deploy/dd-mean
            docker compose pull
            docker compose up -d --remove-orphans
            echo "Deployment finished"
          EOF
